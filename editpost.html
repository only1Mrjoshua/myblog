<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Edit Post</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "signin.html";
      } else {
        function parseJwt(token) {
          try {
            return JSON.parse(atob(token.split(".")[1]));
          } catch (e) {
            return null;
          }
        }

        const payload = parseJwt(token);

        if (!payload || payload.role !== "admin") {
          // Not an admin → kick back to home
          window.location.href = "home.html";
        }
      }
    </script>
  </head>

  <body class="bg-gray-50 text-gray-900">
    <div class="max-w-3xl mx-auto p-6 mt-10 bg-white rounded-xl shadow-md">
      <h1 class="text-2xl font-bold mb-6 text-[#1B5E57]">Edit Post</h1>

      <form method="POST" action="" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Category</label>
          <input
            type="text"
            name="category"
            required
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Title</label>
          <input
            type="text"
            name="title"
            required
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">First Image URL</label>
          <input
            type="text"
            name="image1"
            required
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Intro Content</label>
          <textarea
            name="intro_content"
            rows="3"
            required
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          ></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Content 1</label>
          <textarea
            name="content1"
            rows="4"
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          ></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Quote</label>
          <textarea
            name="quote"
            rows="2"
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          ></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Quote Author</label>
          <input
            type="text"
            name="quote_author"
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Main Content</label>
          <textarea
            name="main_content"
            rows="5"
            required
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          ></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Second Image URL</label>
          <input
            type="text"
            name="image2"
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Final Content</label>
          <textarea
            name="final_content"
            rows="3"
            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1B5E57]"
          ></textarea>
        </div>

        <button
          type="submit"
          class="w-full bg-[#1B5E57] text-white py-2 px-4 rounded-md hover:bg-[#154842] transition"
        >
          Update Post
        </button>
      </form>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "signin.html";
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get("id");

        if (!postId) {
          alert("❌ No post ID provided");
          window.location.href = "managepost.html";
          return;
        }

        const form = document.querySelector("form");

        // Pre-fill the form with post data
        try {
          const res = await fetch(`http://127.0.0.1:8000/posts/${postId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!res.ok) throw new Error("Failed to fetch post");
          const post = await res.json();

          // Populate form fields
          Object.keys(post).forEach((key) => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) input.value = post[key] || "";
          });
        } catch (err) {
          console.error("Error loading post:", err);
          alert("❌ Could not load post details");
          window.location.href = "managepost.html";
        }

        // Handle form submission
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(form);
          const updatedPost = {};
          formData.forEach((value, key) => {
            updatedPost[key] = value.trim();
          });

          try {
            const res = await fetch(`http://127.0.0.1:8000/posts/${postId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(updatedPost),
            });

            if (res.ok) {
              alert("✅ Post updated successfully!");
              window.location.href = "managepost.html";
            } else {
              const errData = await res.json();
              alert(`❌ Error: ${errData.detail || "Failed to update post"}`);
            }
          } catch (err) {
            console.error("Update failed:", err);
            alert("❌ Something went wrong while updating.");
          }
        });
      });
    </script>
  </body>
</html>
