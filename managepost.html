<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Manage Posts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "signin.html";
      } else {
        function parseJwt(token) {
          try {
            return JSON.parse(atob(token.split(".")[1]));
          } catch (e) {
            return null;
          }
        }

        const payload = parseJwt(token);

        if (!payload || payload.role !== "admin") {
          // Not an admin → kick back to home
          window.location.href = "home.html";
        }
      }
    </script>
  </head>

  <body class="bg-gray-50 text-gray-900">
    <div class="max-w-6xl mx-auto p-6 mt-10 bg-white rounded-xl shadow-md">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-[#1B5E57]">Manage Posts</h1>
        <a
          href="addpost.html"
          class="bg-[#1B5E57] text-white px-4 py-2 rounded-md hover:bg-[#154842] transition"
          >+ Add New Post</a
        >
      </div>

      <!-- Posts Table -->
      <table class="w-full border border-gray-200 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-4 py-2">ID</th>
            <th class="border px-4 py-2">Title</th>
            <th class="border px-4 py-2">Category</th>
            <th class="border px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="border px-4 py-2"></td>
            <td class="border px-4 py-2"></td>
            <td class="border px-4 py-2"></td>
            <td class="border px-4 py-2">
              <a href="editpost.html" class="text-blue-600 hover:underline"
                >Edit</a
              >
              |
              <a href="" class="text-red-600 hover:underline">Delete</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="flex justify-end mb-6 max-w-6xl mx-auto p-6 mt-10">
      <a
        href="signin.html"
        id="logoutBtn"
        class="bg-[#1B5E57] text-white px-4 py-2 rounded-md hover:bg-[#154842] transition"
      >
        Logout
      </a>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault(); // stop direct navigation

            // Clear tokens
            localStorage.removeItem("token");
            sessionStorage.clear();

            // Redirect manually
            window.location.href = "signin.html";
          });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Session expired. Please log in again.");
          window.location.href = "signin.html";
          return;
        }

        const tbody = document.querySelector("table tbody");

        // Fetch all posts
        try {
          const res = await fetch("http://127.0.0.1:8000/posts/", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!res.ok) throw new Error("Failed to fetch posts");
          const posts = await res.json();

          tbody.innerHTML = ""; // clear dummy row

          posts.forEach((post) => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
          <td class="border px-4 py-2">${post.id}</td>
          <td class="border px-4 py-2">${post.title}</td>
          <td class="border px-4 py-2">${post.category}</td>
          <td class="border px-4 py-2">
            <a href="editpost.html?id=${post.id}" class="text-blue-600 hover:underline">Edit</a> |
            <button data-id="${post.id}" class="delete-btn text-red-600 hover:underline">Delete</button>
          </td>
        `;

            tbody.appendChild(tr);
          });

          // Handle Delete
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const postId = btn.dataset.id;
              if (!confirm("Are you sure you want to delete this post?"))
                return;

              try {
                const delRes = await fetch(
                  `http://127.0.0.1:8000/posts/${postId}`,
                  {
                    method: "DELETE",
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  }
                );

                if (delRes.ok) {
                  btn.closest("tr").remove(); // remove from table
                  alert("✅ Post deleted successfully!");
                } else {
                  const err = await delRes.json();
                  alert(`❌ Error: ${err.detail || "Failed to delete"}`);
                }
              } catch (err) {
                console.error("Delete failed:", err);
                alert("❌ Something went wrong while deleting.");
              }
            });
          });
        } catch (err) {
          console.error("Error loading posts:", err);
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-600">Failed to load posts.</td></tr>`;
        }
      });
    </script>
  </body>
</html>
